<%= scope.function_template(["oracle/headers/_#{@osfamily.downcase}.sh.erb"]) %>

set -e

ORACLE_HOME="<%= scope['oracle::server::home'] %>"
ORACLE_BASE="<%= scope['oracle::server::base'] %>"
ORACLE_USER="<%= scope['oracle::server::user'] %>"
LD_LIBRARY_PATH=$ORACLE_HOME

EXPORTS="export ORACLE_HOME; export ORACLE_BASE; export LD_LIBRARY_PATH"

START_DB_CMD="$EXPORTS; cd $ORACLE_HOME; $ORACLE_HOME/bin/dbstart"
START_LSNR_CMD="$EXPORTS; cd $ORACLE_HOME; $ORACLE_HOME/bin/lsnrctl start"

STOP_DB_CMD="$EXPORTS; cd $ORACLE_HOME; $ORACLE_HOME/bin/dbshut"
STOP_LSNR_CMD="$EXPORTS; cd $ORACLE_HOME; $ORACLE_HOME/bin/lsnrctl stop"

RETVAL=0


start() {
  [ `id -u` == '0' ] || (echo "Oracle runs as root only .."; exit 5)
  echo "Starting Oracle listener .. "

  su -c "$START_DB_CMD" - $ORACLE_USER
  su -c "$START_LSNR_CMD" - $ORACLE_USER

  RETVAL=$?

  return $RETVAL
}

stop() {
  echo "Stopping Oracle listener .."

  su -c "$STOP_DB_CMD" - $ORACLE_USER
  su -c "$STOP_LSNR_CMD" - $ORACLE_USER

  RETVAL=$?

  return $RETVAL
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  *)
    echo "Usage: $0 {start|stop}"
    exit 0
    ;;
esac
exit $RETVAL
