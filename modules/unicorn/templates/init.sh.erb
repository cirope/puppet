<%= scope.function_template(["unicorn/headers/_#{@osfamily.downcase}.sh.erb"]) %>

set -e

CURRENT_USER=`id -nu`
USER=<%= scope['user::deployer::username'] %>
USER_HOME=<%= scope['user::deployer::home'] %>
BUNDLE=$USER_HOME/.rbenv/shims/bundle

APP_ROOT=<%= scope['vars::apps_root'] %>/<%= @fqdn %>/current
ENV=<%= @virtual == 'virtualbox' ? 'sandbox' : 'production' %>
GEMFILE=$APP_ROOT/Gemfile
UNICORN=$APP_ROOT/bin/unicorn
UNICORN_CONFIG=$APP_ROOT/config/unicorn.rb
PID=/run/unicorn.pid
CMD="cd $APP_ROOT; BUNDLE_GEMFILE=$GEMFILE $BUNDLE exec $UNICORN -D -c $UNICORN_CONFIG -E $ENV"

action="$1"

set -u

cd $APP_ROOT || exit 1

run () {
  if [ $CURRENT_USER = $USER ]; then
    bash -c "$CMD"
  else
    su -c "$CMD" - $USER
  fi
}

sig () {
  test -s "$PID" && kill -$1 `cat $PID`
}

case $action in
start)
  sig 0 && echo >&2 "Already running" && exit 0
  run
  ;;
stop)
  sig QUIT && exit 0
  echo >&2 "Not running"
  ;;
force-stop)
  sig TERM && exit 0
  echo >&2 "Not running"
  ;;
restart|reload|force-reload)
  sig HUP && echo reloaded OK && exit 0
  echo >&2 "Couldn't reload, starting '$CMD' instead"
  run
  ;;
upgrade)
  sig USR2 && exit 0
  echo >&2 "Couldn't upgrade, starting '$CMD' instead"
  run
  ;;
reopen-logs)
  sig USR1
  ;;
*)
  echo >&2 "Usage: $0 <start|stop|restart|reload|force-reload|upgrade|force-stop|reopen-logs>"
  exit 1
  ;;
esac
